<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Detail User Data</title>

  <!-- Bootstrap & Simple DataTables -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/simple-datatables@9.0.0/dist/style.css" rel="stylesheet" />

  <style>
    :root {
      --bg: #f9fafb;
      --card-bg: #ffffff;
      --border: #e5e7eb;
      --text-dark: #1f2937;
      --text-light: #6b7280;
      --accent: #2563eb;
      --accent-light: #dbeafe;
    }

    body {
      background: var(--bg);
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      margin: 0;
      color: var(--text-dark);
    }

    h3 {
      font-weight: 700;
      font-size: 1.5rem;
      margin-bottom: 0;
    }

    .container-fluid {
      max-width: 1200px;
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
    }

    th, td {
      border-right: 1px solid var(--border);
      text-align: center;
      vertical-align: middle;
    }
    th:last-child, td:last-child { border-right: none; }

    th {
      background: #f3f4f6;
      font-weight: 600;
      font-size: 0.85rem;
      color: var(--text-dark);
      white-space: nowrap;
    }

    td {
      font-size: 0.9rem;
      color: var(--text-dark);
    }

    .num {
      text-align: right !important;
      font-variant-numeric: tabular-nums;
    }

    /* Month chips */
    .chips-label {
      font-weight: 600;
      color: var(--text-light);
      margin-bottom: 6px;
    }

    .chip {
      padding: 0.4rem 0.9rem;
      border-radius: 999px;
      background: var(--card-bg);
      border: 1px solid var(--border);
      color: var(--text-dark);
      text-decoration: none;
      font-size: 0.85rem;
      transition: all 0.2s ease;
    }
    .chip:hover,
    .chip.active {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }

    .pill {
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      font-size: 0.75rem;
      display: inline-block;
      white-space: nowrap;
    }
    .pill-yes { background: #dcfce7; color: #166534; }
    .pill-no { background: #fee2e2; color: #991b1b; }
    .pill-seg { background: var(--accent-light); color: var(--accent); }

    .btn-months {
      padding: 0.25rem 0.7rem;
      font-size: 0.8rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
      h3 { font-size: 1.25rem; }
      .chip { font-size: 0.8rem; padding: 0.35rem 0.7rem; }
      table { font-size: 0.8rem; }
      th, td { padding: 0.4rem !important; }
    }
  </style>
</head>

<body class="p-3 p-md-4">
  <div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center flex-wrap mb-4">
      <h3>Detail User Data</h3>
      <a href="/" class="btn btn-outline-secondary btn-sm mt-2 mt-md-0">← Back</a>
    </div>

    {% if error %}
      <div class="alert alert-danger">{{ error }}</div>
    {% endif %}

    {% if data %}

      {# Collect years for dropdown #}
      {% set years = [] %}
      {% for u in data %}
        {% if u.firstTxnYear and (u.firstTxnYear not in years) %}
          {% set _ = years.append(u.firstTxnYear) %}
        {% elif u.signupYear and (u.signupYear not in years) %}
          {% set _ = years.append(u.signupYear) %}
        {% endif %}
      {% endfor %}
      {% set years = years | sort %}

      <!-- Top filters -->
      <div class="d-flex flex-wrap align-items-center justify-content-between mb-2">
        <div>
          <div class="chips-label mb-1">Sort by Acquisition Month</div>
          <div class="d-flex gap-2 flex-wrap mb-2" id="monthChips">
            {% set months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"] %}
            <a href="#" class="chip active" data-month="All">All</a>
            {% for m in months %}
              <a href="#" class="chip" data-month="{{ m }}">{{ m }}</a>
            {% endfor %}
          </div>
        </div>

        <div class="mb-2">
          <label class="chips-label mb-1 d-block">Year</label>
          <select id="yearFilter" class="form-select form-select-sm" style="min-width: 120px;">
            <option value="All" selected>All</option>
            {% for y in years %}
              <option value="{{ y }}">{{ y }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="card p-3">
        <div class="table-responsive">
          <table id="cohortTable" class="table table-hover align-middle mb-0">
            <thead>
              <tr>
                <th>#</th>
                <th>User</th>
                <th>Acquisition</th>
                <th>First Txn</th>
                <th class="num">Total Txns</th>
                <th class="num">Volume (₹)</th>
                <th>Active Months</th>
                <th class="num">Repeat</th>
                <th>Retained</th>
                <th class="num">Avg Txn (₹)</th>
                <th>Segment</th>
                <th>Cohort</th>
                <th>Months</th>
                <th hidden>_acqYearTokens</th>
              </tr>
            </thead>
            <tbody id="cohortTbody">
              {% for u in data %}
                {% set mc = u.monthlyTxnCounts or {} %}
                {% set total = u.totalTxns or 0 %}
                {# frontend logic override for retained + segment #}
                {% set retained = "Yes" if total >= 2 else "No" %}
                {% if total >= 3 %}
                  {% set segment = "Loyal" %}
                {% elif total == 2 %}
                  {% set segment = "Returning" %}
                {% elif total == 1 %}
                  {% set segment = "New" %}
                {% else %}
                  {% set segment = "-" %}
                {% endif %}

                <tr
                  data-acq="{{ u.acquisitionMonth or '-' }}"
                  data-year="{{ u.firstTxnYear or u.signupYear or '-' }}"
                  data-months='{{ mc | tojson }}'
                  data-username='{{ (u.fullName or "User") | e }}'
                >
                  <td>{{ loop.index }}</td>
                  <td>{{ u.fullName or 'N/A' }}</td>
                  <td>{{ u.acquisitionMonth or '-' }}</td>
                  <td>
                    {{ u.firstTxnMonth or '-' }}
                    {% if u.firstTxnYear %} {{ u.firstTxnYear }}{% endif %}
                  </td>
                  <td class="num">{{ total }}</td>
                  <td class="num">{{ '%.2f'|format(u.totalVolume or 0) }}</td>
                  <td>{{ (u.activeMonths or [])|join(', ') }}</td>
                  <td class="num">{{ u.repeatCount or 0 }}</td>
                  <td>
                    {% if retained == "Yes" %}
                      <span class="pill pill-yes">Yes</span>
                    {% else %}
                      <span class="pill pill-no">No</span>
                    {% endif %}
                  </td>
                  <td class="num">{{ u.avgTxnValue or 0 }}</td>
                  <td><span class="pill pill-seg">{{ segment }}</span></td>
                  <td>{{ u.cohortLabel or '-' }}</td>
                  <td>
                    <button type="button"
                            class="btn btn-outline-primary btn-months"
                            onclick="openMonthsModal(this)">
                      View
                    </button>
                  </td>
                  <td hidden>
                    acq:{{ u.acquisitionMonth or '-' }}
                    year:{{ u.firstTxnYear or u.signupYear or '-' }}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% else %}
      <div class="alert alert-info">No data available.</div>
    {% endif %}
  </div>

  <!-- Month-wise modal -->
  <div class="modal fade" id="monthsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title" id="monthsTitle">Month-wise Transactions</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <ul id="monthsList" class="list-group small"></ul>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/simple-datatables@9.0.0/dist/umd/simple-datatables.min.js"></script>

  <script>
    const MONTH_ORDER = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

    document.addEventListener("DOMContentLoaded", function () {
      const tableEl = document.getElementById("cohortTable");
      if (!tableEl) return;

      const dt = new simpleDatatables.DataTable(tableEl, {
        searchable: true,
        perPage: 25,
        perPageSelect: [5,10,25,50,100],
        fixedHeight: false,
        labels: {
          placeholder: "Search...",
          noRows: "No records found",
          info: "Showing {start}–{end} of {rows}"
        },
        columns: [{ select: [0], sortable: false }]
      });

      function getPerPage() {
        const sel = document.querySelector(".datatable-selector");
        return sel ? parseInt(sel.value, 10) || 25 : 25;
      }
      function getCurrentPage() {
        const active = document.querySelector(".datatable-pagination .datatable-active");
        return active ? parseInt(active.textContent, 10) || 1 : 1;
      }
      function renumber() {
        const perPage = getPerPage();
        const currentPage = getCurrentPage();
        const offset = (currentPage - 1) * perPage;
        const rows = tableEl.querySelectorAll("tbody tr");
        rows.forEach((tr, i) => {
          const cell = tr.querySelector("td");
          if (cell) cell.textContent = offset + i + 1;
        });
      }
      ["datatable.init","datatable.update","datatable.page","datatable.sort","datatable.search","datatable.perpage"]
        .forEach(ev => dt.on(ev, () => setTimeout(renumber, 80)));
      setTimeout(renumber, 200);

      // Month + Year combined filter using hidden token column
      let currentMonth = "All";
      let currentYear = "All";

      function applyFilters() {
        const parts = [];
        if (currentMonth !== "All") parts.push("acq:" + currentMonth);
        if (currentYear !== "All") parts.push("year:" + currentYear);
        const query = parts.join(" ");
        dt.search(query);
        setTimeout(renumber, 150);
      }

      const chips = document.querySelectorAll("#monthChips .chip");
      chips.forEach(chip => {
        chip.addEventListener("click", e => {
          e.preventDefault();
          chips.forEach(c => c.classList.remove("active"));
          chip.classList.add("active");
          currentMonth = chip.dataset.month;
          applyFilters();
        });
      });

      const yearFilter = document.getElementById("yearFilter");
      if (yearFilter) {
        yearFilter.addEventListener("change", () => {
          currentYear = yearFilter.value;
          applyFilters();
        });
      }
    });

    // Month-wise modal
    function openMonthsModal(button) {
      const tr = button.closest("tr");
      if (!tr) return;
      const raw = tr.getAttribute("data-months") || "{}";
      const name = tr.getAttribute("data-username") || "User";
      let counts = {};
      try { counts = JSON.parse(raw); } catch (e) { counts = {}; }

      const list = document.getElementById("monthsList");
      list.innerHTML = "";

      MONTH_ORDER.forEach(m => {
        const li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between";
        li.innerHTML = `<span>${m}</span><strong>${counts[m] || 0}</strong>`;
        list.appendChild(li);
      });

      document.getElementById("monthsTitle").textContent = `Transactions – ${name}`;
      const modal = new bootstrap.Modal(document.getElementById("monthsModal"));
      modal.show();
    }
  </script>
</body>
</html>
