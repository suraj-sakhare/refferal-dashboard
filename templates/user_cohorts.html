<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>User Cohort Tracker</title>

  <!-- Bootstrap & Simple DataTables -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/simple-datatables@9.0.0/dist/style.css" rel="stylesheet" />

  <style>
    :root {
      --bg: #f9fafb;
      --card-bg: #ffffff;
      --border: #e5e7eb;
      --text-dark: #1f2937;
      --text-light: #6b7280;
      --accent: #2563eb;
      --accent-light: #dbeafe;
    }

    body {
      background: var(--bg);
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      margin: 0;
      color: var(--text-dark);
    }

    h3 {
      font-weight: 700;
      font-size: 1.5rem;
      margin-bottom: 0;
    }

    .container-fluid {
      max-width: 1200px;
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
    }

    th, td {
      border-right: 1px solid var(--border);
      text-align: center;
      vertical-align: middle;
    }
    th:last-child, td:last-child { border-right: none; }

    th {
      background: #f3f4f6;
      font-weight: 600;
      font-size: 0.85rem;
      color: var(--text-dark);
      white-space: nowrap;
    }

    td {
      font-size: 0.9rem;
      color: var(--text-dark);
    }

    .num {
      text-align: right !important;
      font-variant-numeric: tabular-nums;
    }

    /* Month chips */
    .chips-label {
      font-weight: 600;
      color: var(--text-light);
      margin-bottom: 6px;
    }

    .chip {
      padding: 0.4rem 0.9rem;
      border-radius: 999px;
      background: var(--card-bg);
      border: 1px solid var(--border);
      color: var(--text-dark);
      text-decoration: none;
      font-size: 0.85rem;
      transition: all 0.2s ease;
    }
    .chip:hover,
    .chip.active {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }

    .pill {
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      font-size: 0.75rem;
      display: inline-block;
      white-space: nowrap;
    }
    .pill-yes { background: #dcfce7; color: #166534; }
    .pill-no { background: #fee2e2; color: #991b1b; }
    .pill-seg { background: var(--accent-light); color: var(--accent); }

    /* Responsive */
    @media (max-width: 768px) {
      h3 { font-size: 1.25rem; }
      .chip { font-size: 0.8rem; padding: 0.35rem 0.7rem; }
      table { font-size: 0.8rem; }
      th, td { padding: 0.4rem !important; }
    }
  </style>
</head>

<body class="p-3 p-md-4">
  <div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center flex-wrap mb-4">
      <h3>User Cohort Tracker</h3>
      <a href="/" class="btn btn-outline-secondary btn-sm mt-2 mt-md-0">← Back</a>
    </div>

    {% if error %}
      <div class="alert alert-danger">{{ error }}</div>
    {% endif %}

    {% if data %}
      <!-- Month sorting label -->
      <div class="chips-label">Sort by Acquisition Month</div>
      <div class="d-flex gap-2 flex-wrap mb-3" id="monthChips">
        {% set months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"] %}
        <a href="#" class="chip active" data-month="All">All</a>
        {% for m in months %}
          <a href="#" class="chip" data-month="{{ m }}">{{ m }}</a>
        {% endfor %}
      </div>

      <div class="card p-3">
        <div class="table-responsive">
          <table id="cohortTable" class="table table-hover align-middle mb-0">
            <thead>
              <tr>
                <th>#</th>
                <th>User</th>
                <th>Acquisition</th>
                <th>First Txn</th>
                <th class="num">Jan</th>
                <th class="num">Feb</th>
                <th class="num">Mar</th>
                <th class="num">Apr</th>
                <th class="num">May</th>
                <th class="num">Jun</th>
                <th class="num">Jul</th>
                <th class="num">Aug</th>
                <th class="num">Sep</th>
                <th class="num">Oct</th>
                <th class="num">Nov</th>
                <th class="num">Dec</th>
                <th class="num">Total Txns</th>
                <th class="num">Volume (₹)</th>
                <th>Active Months</th>
                <th>Repeat</th>
                <th>Retained</th>
                <th>Avg Txn (₹)</th>
                <th>Segment</th>
                <th>Cohort</th>
                <th hidden>_acqOnly</th>
              </tr>
            </thead>
            <tbody id="cohortTbody">
              {% for u in data %}
                {% set mc = u.monthlyTxnCounts or {} %}
                <tr data-acq="{{ u.acquisitionMonth or '-' }}">
                  <td>{{ loop.index }}</td>
                  <td>{{ u.fullName or 'N/A' }}</td>
                  <td>{{ u.acquisitionMonth or '-' }}</td>
                  <td>{{ u.firstTxnMonth or '-' }}</td>
                  <td class="num">{{ mc.get('Jan',0) }}</td>
                  <td class="num">{{ mc.get('Feb',0) }}</td>
                  <td class="num">{{ mc.get('Mar',0) }}</td>
                  <td class="num">{{ mc.get('Apr',0) }}</td>
                  <td class="num">{{ mc.get('May',0) }}</td>
                  <td class="num">{{ mc.get('Jun',0) }}</td>
                  <td class="num">{{ mc.get('Jul',0) }}</td>
                  <td class="num">{{ mc.get('Aug',0) }}</td>
                  <td class="num">{{ mc.get('Sep',0) }}</td>
                  <td class="num">{{ mc.get('Oct',0) }}</td>
                  <td class="num">{{ mc.get('Nov',0) }}</td>
                  <td class="num">{{ mc.get('Dec',0) }}</td>
                  <td class="num">{{ u.totalTxns or 0 }}</td>
                  <td class="num">{{ '%.2f'|format(u.totalVolume or 0) }}</td>
                  <td>{{ (u.activeMonths or [])|join(', ') }}</td>
                  <td class="num">{{ u.repeatCount or 0 }}</td>
                  <td>
                    {% if (u.lifetimeRetained or '').lower() in ['yes','y','true','1'] %}
                      <span class="pill pill-yes">Yes</span>
                    {% else %}
                      <span class="pill pill-no">No</span>
                    {% endif %}
                  </td>
                  <td class="num">{{ u.avgTxnValue or 0 }}</td>
                  <td><span class="pill pill-seg">{{ u.userSegment or '-' }}</span></td>
                  <td>{{ u.cohortLabel or '-' }}</td>
                  <td hidden>acq:{{ u.acquisitionMonth }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% else %}
      <div class="alert alert-info">No data available.</div>
    {% endif %}
  </div>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/simple-datatables@9.0.0/dist/umd/simple-datatables.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const tableEl = document.getElementById("cohortTable");
      if (!tableEl) return;

      const dt = new simpleDatatables.DataTable(tableEl, {
        searchable: true,
        perPage: 25,
        perPageSelect: [5,10,25,50,100],
        fixedHeight: false,
        labels: {
          placeholder: "Search...",
          noRows: "No records found",
          info: "Showing {start}–{end} of {rows}"
        },
        columns: [{ select: [0], sortable: false }]
      });

      function getPerPage() {
        const sel = document.querySelector(".datatable-selector");
        return sel ? parseInt(sel.value, 10) || 25 : 25;
      }
      function getCurrentPage() {
        const active = document.querySelector(".datatable-pagination .datatable-active");
        return active ? parseInt(active.textContent, 10) || 1 : 1;
      }
      function renumber() {
        const perPage = getPerPage();
        const currentPage = getCurrentPage();
        const offset = (currentPage - 1) * perPage;
        const rows = tableEl.querySelectorAll("tbody tr");
        rows.forEach((tr, i) => {
          const cell = tr.querySelector("td");
          if (cell) cell.textContent = offset + i + 1;
        });
      }
      ["datatable.init","datatable.update","datatable.page","datatable.sort","datatable.search","datatable.perpage"]
        .forEach(ev => dt.on(ev, () => setTimeout(renumber, 80)));
      setTimeout(renumber, 200);

      const chips = document.querySelectorAll("#monthChips .chip");
      chips.forEach(chip => {
        chip.addEventListener("click", e => {
          e.preventDefault();
          chips.forEach(c => c.classList.remove("active"));
          chip.classList.add("active");
          const m = chip.dataset.month;
          if (m === "All") dt.search("");
          else dt.search("acq:" + m);
          setTimeout(renumber, 150);
        });
      });
    });
  </script>
</body>
</html>
